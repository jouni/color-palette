<!doctype html>
<html>
<head>
<link rel="stylesheet" href="lumo.css">

<style>
  html {
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .light,
  .dark,
  .dim {
    background-color: var(--lumo-base-color);
    color: var(--lumo-body-text-color);
  }

  .dim {
    background-color: var(--lumo-contrast-5pct);
  }

  section {
    padding: 0.5rem;
  }

  p {
    margin: 0;
  }

  .low-contrast {
    outline: 2px dashed red;
    box-shadow: 0 0 0 2px white;
  }

  .text {
    display: inline-block;
  }

  .secondary {
    color: var(--lumo-secondary-text-color);
  }

  .tertiary {
    color: var(--lumo-tertiary-text-color);
  }

  .primary {
    color: var(--lumo-primary-text-color);
  }

  .error {
    color: var(--lumo-error-text-color);
  }

  .success {
    color: var(--lumo-success-text-color);
  }

  .badge {
    display: inline-block;
    font-size: 0.9em;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    width: min-content;
    white-space: nowrap;
    font-weight: 500;
  }

  .badge.primary {
    background-color: var(--lumo-primary-color-10pct);
  }

  .badge.error {
    background-color: var(--lumo-error-color-10pct);
  }

  .badge.success {
    background-color: var(--lumo-success-color-10pct);
  }

  .item {
    display: inline-block;
    padding: 0.5em 4em 0.5em 1em;
    border-radius: 0.25rem;
  }

  .item.hover {
    background-color: var(--lumo-primary-color-10pct);
  }

  .rte {
    display: inline-block;
    background-color: var(--lumo-contrast-5pct);
  }

  .rte-button {
    display: inline-block;
    padding: 0.75rem;
    border-radius: 0.25rem;
    font-weight: 600;
    margin: 0;
    width: min-content;
    white-space: nowrap;
    color: var(--lumo-contrast-60pct);
  }

  .rte-button.hover {
    background-color: var(--lumo-contrast-5pct);
    color: var(--lumo-contrast-80pct);
  }

  .button {
    display: inline-block;
    padding: 0.5em 1em;
    border-radius: 0.25rem;
    font-weight: 600;
    background-color: var(--lumo-contrast-5pct);
    text-align: center;
    position: relative;
    color: var(--lumo-primary-text-color);
    cursor: default;
    user-select: none;
  }

  .button.primary {
    color: var(--lumo-primary-text-color);
  }

  .button.error {
    color: var(--lumo-error-text-color);
  }

  .button.success {
    color: var(--lumo-success-text-color);
  }

  .button.primary {
    color: var(--lumo-primary-contrast-color);
    background-color: var(--lumo-primary-color);
    --_button-color-brightness-adjust: 0.98;
  }

  .button.primary.error {
    color: var(--lumo-error-contrast-color);
    background-color: var(--lumo-error-color);
  }

  .button.primary.success {
    color: var(--lumo-success-contrast-color);
    background-color: var(--lumo-success-color);
  }

  /* Lumo prior to V22 */
  /* .button.hover span::before,
  .button.active span::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: currentColor;
    opacity: 0.05;
    border-radius: 0.25rem;
  }

  .button.primary.hover span::before,
  .button.active span::before {
    opacity: 0.1;
  }

  .button.primary.active span::before {
    background: var(--lumo-contrast-20pct);
  } */

  .button:hover::before,
  .button.hover::before,
  .button:active::before,
  .button.active::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    border-radius: 0.25rem;
    pointer-events: none;
    background-color: currentColor;
    opacity: 0.02;
  }

  .button:active::before,
  .button.active::before {
    opacity: 0.05;
  }

  .button.primary:hover::before,
  .button.primary.hover::before {
    opacity: 0.05;
    background-color: black;
  }

  .button.primary:active::before,
  .button.primary.active::before {
    opacity: 0.1;
    background-color: black;
  }

  .button.tertiary {
    background: transparent;
  }

  .outline {
    display: inline-block;
    color: var(--lumo-primary-color-50pct);
    border: 2px solid;
    border-radius: 0.375rem;
    padding: 0.5em;
  }

  .outline.error {
    color: var(--lumo-error-color-50pct);
  }

  .outline.success {
    color: var(--lumo-success-color-50pct);
  }

  .input-bg {
    display: inline-block;
    color: var(--lumo-body-text-color);
    background-color: var(--lumo-contrast-10pct);
    border-radius: 0.25rem;
    padding: 0.5em;
    font-weight: 500;
  }


  body {
    display: flex;
    margin: 0;
    padding: 1rem;
    gap: 1rem;
  }

  .css-text {
    align-self: stretch;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 2rem);
    position: sticky;
    top: 0;
    font-family: monospace;
    font-size: 1rem;
  }

  .css-text textarea {
    flex: auto;
    font: inherit;
  }

  .contrast-value {
    font-style: normal;
    margin-inline-start: .2em;
  }
</style>
<style id="css"></style>
</head>
<body>

<label class="css-text">
html {
<textarea id="css-text"></textarea>
}
</label>

<div>
<div class="light">
  <section>
    <p class="text body"><span>Body</span></p>
    <p class="text secondary"><span>Secondary</span></p>
    <p class="text tertiary"><span class="level-a">Tertiary</span></p>
    <p class="text primary"><span>Text</span></p>
    <p class="text error"><span>Text</span></p>
    <p class="text success"><span>Text</span></p>

    <p class="badge primary"><span>Badge</span></p>
    <p class="badge error"><span>Badge</span></p>
    <p class="badge success"><span>Badge</span></p>

    <p class="item"><span>Item</span></p>
    <p class="item hover"><span>Item</span></p>

    <div class="rte">
      <p class="rte-button"><span class="level-a">B</span></p>
      <p class="rte-button hover"><span>B</span></p>
    </div>

    <p class="outline"><span class="level-a">Focus outline</span></p>
    <p class="outline error"><span class="level-a">Error outline</span></p>
    <p class="outline success"><span class="level-a">Success outline</span></p>
    <p class="input-bg"><span class="level-a">Text input</span></p>
  </section>


  <section>
    <p class="button tertiary"><span>Button</span></p>
    <p class="button tertiary hover"><span>Hover</span></p>
    <p class="button tertiary active"><span>Active</span></p>
    <p class="button tertiary error"><span>Button</span></p>
    <p class="button tertiary error hover"><span>Hover</span></p>
    <p class="button tertiary error active"><span>Active</span></p>
    <p class="button tertiary success"><span>Button</span></p>
    <p class="button tertiary success hover"><span>Hover</span></p>
    <p class="button tertiary success active"><span>Active</span></p>
  </section>

  <section>
    <p class="button"><span>Button</span></p>
    <p class="button hover"><span>Hover</span></p>
    <p class="button active"><span>Active</span></p>
    <p class="button error"><span>Button</span></p>
    <p class="button error hover"><span>Hover</span></p>
    <p class="button error active"><span>Active</span></p>
    <p class="button success"><span>Button</span></p>
    <p class="button success hover"><span>Hover</span></p>
    <p class="button success active"><span>Active</span></p>
  </section>

  <section>
    <p class="button primary"><span>Primary</span></p>
    <p class="button primary hover"><span>Hover</span></p>
    <p class="button primary active"><span>Active</span></p>
    <p class="button primary error"><span>Error</span></p>
    <p class="button primary error hover"><span>Hover</span></p>
    <p class="button primary error active"><span>Active</span></p>
    <p class="button primary success"><span>Success</span></p>
    <p class="button primary success hover"><span>Hover</span></p>
    <p class="button primary success active"><span>Active</span></p>
  </section>
</div>

<div class="light">
  <div class="dim"></div>
</div>

<div class="dark"></div>

<div class="dark">
  <div class="dim"></div>
</div>

</div>


<script type="module">
  import {normal as blendColors} from './node_modules/color-blend/dist/index.mjs';
  import {getComputedColor, getContrast, rgbToHsl, hslToRgb, luminance} from './ColorUtil.js';

  const testContent = document.querySelector('.light').innerHTML;
  document.querySelector('.light .dim').innerHTML = testContent;
  document.querySelector('.dark').innerHTML = testContent;
  document.querySelector('.dark .dim').innerHTML = testContent;

  function calculateContrast(el) {
    let curEl = el;
    const colorStack = [];
    do {
      let color = getComputedColor(curEl, curEl === el ? 'color' : 'background-color');
      if (curEl === document.documentElement && color.a === 0) {
        // Assuming the default white background (user-agent style sheet)
        color = {r:255,g:255,b:255,a:1};
      }
      colorStack.unshift(color);

      curEl = curEl.parentNode;
    } while (curEl !== document);

    let fg = colorStack.reduce((acc, cur, curIndex, array) => {
      return blendColors(acc, cur);
    });

    colorStack.pop();

    let bg = colorStack.reduce((acc, cur, curIndex, array) => {
      return blendColors(acc, cur);
    });

    // Lumo button state implementation prior to V22
    // // Potential hover/active state
    // let stateOverlayColor = getComputedColor(el, 'background-color', '::before');
    // if (stateOverlayColor.a > 0) {
    //   stateOverlayColor.a = parseFloat(getComputedStyle(el, '::before').getPropertyValue('opacity'));
    // } else {
    //   stateOverlayColor = undefined;
    // }
    //
    // if (stateOverlayColor) {
    //   fg = blendColors(fg, stateOverlayColor);
    //   bg = blendColors(bg, stateOverlayColor);
    // }

    // Potential hover/active state
    if (el.closest('.button')) {

      // if (el.closest('.button:is(.hover, .active)')) {
      //   const fgHsl = rgbToHsl(fg);
      //   fgHsl.l = Math.min(parseFloat(getComputedStyle(el).getPropertyValue('filter').split('(')[1]) * fgHsl.l, 100);
      //   fg = hslToRgb(fgHsl);
      // }

      // Background overlay
      const stateOverlayColor = getComputedColor(el.closest('.button'), 'background-color', '::before');
      stateOverlayColor.a *= parseFloat(getComputedStyle(el.closest('.button'), '::before').getPropertyValue('opacity'));
      fg = blendColors(fg, stateOverlayColor);
      bg = blendColors(bg, stateOverlayColor);
    }

    const contrastBg = getContrast(bg, fg);
    const levelBg = contrastBg >= 7 ? 'aaa' : (contrastBg >= 4.5 ? 'aa' : (contrastBg >= 3 ? 'aa-bold' : undefined));

    return {
      bg: {value: contrastBg, level: levelBg},
    };
  }

  function updateContrastValues() {
    Array.from(document.querySelectorAll('span')).forEach(el => {
      const contrast = calculateContrast(el);
      if (contrast.bg.value.toFixed(2) < 4.5 && !el.classList.contains('level-a')) {
        el.classList.add('low-contrast');
      } else if (contrast.bg.value.toFixed(2) < 3) {
        el.classList.add('low-contrast');
      } else {
        el.classList.remove('low-contrast');
      }
      let contrastVal;
      if (!(contrastVal = el.querySelector('.contrast-value'))) {
        contrastVal = document.createElement('em');
        contrastVal.className = 'contrast-value';
        el.appendChild(contrastVal);
      }
      contrastVal.textContent = contrast.bg.value.toFixed(2);
    });
  }

  const cssText = document.querySelector('#css-text');
  const css = document.querySelector('#css')

  cssText.oninput = () => {
    css.innerHTML = `html { ${cssText.value} }`;
    updateContrastValues();
  }

  requestAnimationFrame(() => {
    updateContrastValues();
  });
</script>

</body>
</html>
